Voici un exemple complet (Spring MVC + JSP + Spring Data JPA, Java 8) qui :
Upload un CSV (avec ou sans header)
Pour chaque ligne : tokenReqId,newStatus
Cherche en base par tokenRequestId
Met à jour status et copie l’ancien dans oldStatus
Retourne à la JSP :
la liste des lignes mises à jour (3 colonnes uniquement)
le nombre de lignes mises à jour
le nombre de lignes ignorées
Désactive le bouton pendant l’import
1) Enum TokenRequestorStatus.java
Copier le code
Java
package com.myapp.domain;

public enum TokenRequestorStatus {

    ACTIF("Actif"),
    SUSPENDU("Suspendu"),
    DESACTIVE("Désactivé");

    private final String label;

    TokenRequestorStatus(String label) {
        this.label = label;
    }

    public String getLabel() {
        return label;
    }

    public static TokenRequestorStatus fromLabel(String label) {
        if (label == null) throw new IllegalArgumentException("Statut vide");

        String v = label.trim();

        for (TokenRequestorStatus s : values()) {
            if (s.label.equalsIgnoreCase(v)) return s;
        }

        // optionnel : accepter aussi ACTIF/SUSPENDU/DESACTIVE venant du CSV
        for (TokenRequestorStatus s : values()) {
            if (s.name().equalsIgnoreCase(v)) return s;
        }

        throw new IllegalArgumentException("Statut invalide: " + label);
    }
}
2) Entity TokenRequestor.java
Copier le code
Java
package com.myapp.domain;

import javax.persistence.*;

@Entity
@Table(name = "TOKEN_REQUESTOR")
public class TokenRequestor {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "TOKEN_REQUEST_ID", unique = true, nullable = false)
    private Long tokenRequestId;

    @Enumerated(EnumType.STRING)
    @Column(name = "STATUS")
    private TokenRequestorStatus status;

    @Enumerated(EnumType.STRING)
    @Column(name = "OLD_STATUS")
    private TokenRequestorStatus oldStatus;

    public Long getId() { return id; }
    public Long getTokenRequestId() { return tokenRequestId; }
    public void setTokenRequestId(Long tokenRequestId) { this.tokenRequestId = tokenRequestId; }

    public TokenRequestorStatus getStatus() { return status; }
    public void setStatus(TokenRequestorStatus status) { this.status = status; }

    public TokenRequestorStatus getOldStatus() { return oldStatus; }
    public void setOldStatus(TokenRequestorStatus oldStatus) { this.oldStatus = oldStatus; }
}
3) Repository TokenRequestorRepository.java
Copier le code
Java
package com.myapp.repository;

import com.myapp.domain.TokenRequestor;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.Optional;

public interface TokenRequestorRepository extends JpaRepository<TokenRequestor, Long> {
    Optional<TokenRequestor> findByTokenRequestId(Long tokenRequestId);
}
4) DTO ligne mise à jour TokenRequestorUpdateResultDTO.java
Copier le code
Java
package com.myapp.dto;

import com.myapp.domain.TokenRequestorStatus;

public class TokenRequestorUpdateResultDTO {

    private final Long tokenRequestId;
    private final TokenRequestorStatus status;
    private final TokenRequestorStatus oldStatus;

    public TokenRequestorUpdateResultDTO(Long tokenRequestId,
                                         TokenRequestorStatus status,
                                         TokenRequestorStatus oldStatus) {
        this.tokenRequestId = tokenRequestId;
        this.status = status;
        this.oldStatus = oldStatus;
    }

    public Long getTokenRequestId() { return tokenRequestId; }
    public TokenRequestorStatus getStatus() { return status; }
    public TokenRequestorStatus getOldStatus() { return oldStatus; }
}
5) Résultat global import TokenRequestorImportResult.java
Copier le code
Java
package com.myapp.dto;

import java.util.ArrayList;
import java.util.List;

public class TokenRequestorImportResult {

    private final List<TokenRequestorUpdateResultDTO> updatedRows = new ArrayList<>();
    private int updatedCount;
    private int ignoredCount;

    public void addUpdated(TokenRequestorUpdateResultDTO dto) {
        updatedRows.add(dto);
        updatedCount++;
    }

    public void incrementIgnored() {
        ignoredCount++;
    }

    public List<TokenRequestorUpdateResultDTO> getUpdatedRows() { return updatedRows; }
    public int getUpdatedCount() { return updatedCount; }
    public int getIgnoredCount() { return ignoredCount; }
}
6) Service TokenRequestorImportService.java
Copier le code
Java
package com.myapp.service;

import com.myapp.domain.TokenRequestor;
import com.myapp.domain.TokenRequestorStatus;
import com.myapp.dto.TokenRequestorImportResult;
import com.myapp.dto.TokenRequestorUpdateResultDTO;
import com.myapp.repository.TokenRequestorRepository;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import java.io.*;
import java.nio.charset.StandardCharsets;
import java.util.Optional;

@Service
public class TokenRequestorImportService {

    private final TokenRequestorRepository repository;

    public TokenRequestorImportService(TokenRequestorRepository repository) {
        this.repository = repository;
    }

    private boolean isHeader(String line) {
        // header si la première colonne n'est pas numérique
        String[] parts = line.split(",");
        if (parts.length == 0) return true;
        String first = parts[0].trim();
        return !first.matches("\\d+");
    }

    @Transactional
    public TokenRequestorImportResult importCsv(MultipartFile file) {
        if (file == null || file.isEmpty()) {
            throw new IllegalArgumentException("Fichier vide");
        }

        TokenRequestorImportResult result = new TokenRequestorImportResult();

        try (BufferedReader br = new BufferedReader(
                new InputStreamReader(file.getInputStream(), StandardCharsets.UTF_8))) {

            String line;
            boolean firstLine = true;

            while ((line = br.readLine()) != null) {
                line = line.trim();
                if (line.isEmpty()) {
                    result.incrementIgnored();
                    continue;
                }

                // gérer header optionnel
                if (firstLine) {
                    firstLine = false;
                    if (isHeader(line)) {
                        continue;
                    }
                }

                try {
                    String[] columns = line.split(",");
                    if (columns.length < 2) {
                        result.incrementIgnored();
                        continue;
                    }

                    Long tokenReqId = Long.parseLong(columns[0].trim());
                    TokenRequestorStatus newStatus = TokenRequestorStatus.fromLabel(columns[1]);

                    Optional<TokenRequestor> optional = repository.findByTokenRequestId(tokenReqId);
                    if (!optional.isPresent()) {
                        result.incrementIgnored();
                        continue;
                    }

                    TokenRequestor tr = optional.get();
                    TokenRequestorStatus oldStatus = tr.getStatus();

                    // si identique => ignoré (ou tu peux le considérer "updated" si tu veux)
                    if (newStatus == oldStatus) {
                        result.incrementIgnored();
                        continue;
                    }

                    tr.setOldStatus(oldStatus);
                    tr.setStatus(newStatus);
                    repository.save(tr);

                    result.addUpdated(new TokenRequestorUpdateResultDTO(tokenReqId, newStatus, oldStatus));

                } catch (Exception e) {
                    // Ligne invalide => ignorée, import continue
                    result.incrementIgnored();
                }
            }

        } catch (IOException e) {
            throw new RuntimeException("Erreur lecture CSV", e);
        }

        return result;
    }
}
7) Controller TokenRequestorImportController.java
Copier le code
Java
package com.myapp.web;

import com.myapp.dto.TokenRequestorImportResult;
import com.myapp.service.TokenRequestorImportService;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.util.ArrayList;

@Controller
@RequestMapping("/tokenrequestor")
public class TokenRequestorImportController {

    private final TokenRequestorImportService importService;

    public TokenRequestorImportController(TokenRequestorImportService importService) {
        this.importService = importService;
    }

    @GetMapping("/import")
    public String showPage(Model model) {
        model.addAttribute("results", new ArrayList<>());
        model.addAttribute("updatedCount", 0);
        model.addAttribute("ignoredCount", 0);
        return "import-tokenrequestor";
    }

    @PostMapping("/import")
    public String importFile(@RequestParam("file") MultipartFile file, Model model) {
        try {
            TokenRequestorImportResult res = importService.importCsv(file);
            model.addAttribute("results", res.getUpdatedRows());
            model.addAttribute("updatedCount", res.getUpdatedCount());
            model.addAttribute("ignoredCount", res.getIgnoredCount());
        } catch (Exception e) {
            model.addAttribute("results", new ArrayList<>());
            model.addAttribute("updatedCount", 0);
            model.addAttribute("ignoredCount", 0);
            model.addAttribute("error", e.getMessage());
        }
        return "import-tokenrequestor";
    }
}
8) JSP import-tokenrequestor.jsp
Place-le dans : WEB-INF/views/import-tokenrequestor.jsp
Copier le code
Jsp
<%@ page contentType="text/html; charset=UTF-8" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>

<html>
<head>
    <title>Import TokenRequestor</title>

    <script>
        function disableButton() {
            var btn = document.getElementById("importBtn");
            btn.disabled = true;
            btn.innerText = "Import en cours...";
        }
    </script>
</head>
<body>

<h2>Importer un fichier CSV (tokenReqId,status)</h2>

<form method="post" enctype="multipart/form-data" onsubmit="disableButton()">
    <input type="file" name="file" accept=".csv" required />
    <button type="submit" id="importBtn">Importer</button>
</form>

<c:if test="${not empty error}">
    <p style="color:red; margin-top:10px;">
        Erreur: ${error}
    </p>
</c:if>

<p style="margin-top:15px;">
    ✅ Lignes mises à jour : <b>${updatedCount}</b><br/>
    ⚠️ Lignes ignorées : <b>${ignoredCount}</b>
</p>

<h3>Tokens mis à jour</h3>

<table border="1" cellpadding="6" cellspacing="0">
    <thead>
        <tr>
            <th>TokenRequestId</th>
            <th>Status</th>
            <th>Old Status</th>
        </tr>
    </thead>
    <tbody>
        <c:forEach items="${results}" var="r">
            <tr>
                <td>${r.tokenRequestId}</td>
                <!-- si tu veux le label: ${r.status.label} -->
                <td>${r.status}</td>
                <td>${r.oldStatus}</td>
            </tr>
        </c:forEach>

        <c:if test="${empty results}">
            <tr>
                <td colspan="3" style="text-align:center;">Aucune mise à jour</td>
            </tr>
        </c:if>
    </tbody>
</table>

</body>
</html>








<%@ page contentType="text/html; charset=UTF-8" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>

<html>
<head>
    <title>Import TokenRequestor (AJAX)</title>
</head>
<body>

<h2>Importer CSV (AJAX)</h2>

<div style="margin-bottom:10px;">
    <input type="file" id="csvFile" accept=".csv" />
    <button id="importBtn" type="button" onclick="uploadCsv()">Importer</button>
    <span id="loading" style="margin-left:10px;"></span>
</div>

<div id="msg" style="color:red; margin-bottom:10px;"></div>

<p>
    ✅ Lignes mises à jour : <b id="updatedCount">0</b><br/>
    ⚠️ Lignes ignorées : <b id="ignoredCount">0</b>
</p>

<h3>Tokens mis à jour</h3>

<table border="1" cellpadding="6" cellspacing="0" style="width:700px;">
    <thead>
        <tr>
            <th>TokenRequestId</th>
            <th>Status</th>
            <th>Old Status</th>
        </tr>
    </thead>
    <tbody id="resultBody">
        <tr><td colspan="3" style="text-align:center;">Aucune donnée</td></tr>
    </tbody>
</table>

<script>
async function uploadCsv() {
    const fileInput = document.getElementById("csvFile");
    const btn = document.getElementById("importBtn");
    const msg = document.getElementById("msg");
    const loading = document.getElementById("loading");

    msg.innerText = "";

    if (!fileInput.files || fileInput.files.length === 0) {
        msg.innerText = "Veuillez sélectionner un fichier CSV.";
        return;
    }

    const formData = new FormData();
    formData.append("file", fileInput.files[0]);

    // UI: disable pendant import
    btn.disabled = true;
    const oldBtnText = btn.innerText;
    btn.innerText = "Import en cours...";
    loading.innerText = "⏳";

    try {
        const resp = await fetch("<c:url value='/tokenrequestor/import-ajax'/>", {
            method: "POST",
            body: formData
        });

        const data = await resp.json();

        if (!resp.ok) {
            msg.innerText = data && data.message ? data.message : "Erreur import.";
            return;
        }

        // stats
        document.getElementById("updatedCount").innerText = data.updatedCount;
        document.getElementById("ignoredCount").innerText = data.ignoredCount;

        // table
        const tbody = document.getElementById("resultBody");
        tbody.innerHTML = "";

        if (!data.rows || data.rows.length === 0) {
            tbody.innerHTML = "<tr><td colspan='3' style='text-align:center;'>Aucune mise à jour</td></tr>";
            return;
        }

        data.rows.forEach(r => {
            const tr = document.createElement("tr");

            const td1 = document.createElement("td");
            td1.innerText = r.tokenRequestId;

            const td2 = document.createElement("td");
            td2.innerText = r.status;

            const td3 = document.createElement("td");
            td3.innerText = r.oldStatus;

            tr.appendChild(td1);
            tr.appendChild(td2);
            tr.appendChild(td3);

            tbody.appendChild(tr);
        });

    } catch (e) {
        msg.innerText = "Erreur réseau / serveur.";
    } finally {
        // UI: re-enable
        loading.innerText = "";
        btn.disabled = false;
        btn.innerText = oldBtnText;
    }
}
</script>

</body>
</html>